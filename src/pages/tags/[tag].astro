---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const tagSet = new Set<string>();

  for (const post of posts) {
    const tags = post.data.tags ?? [];
    for (const tag of tags) {
      tagSet.add(tag);
    }
  }

  return Array.from(tagSet).map((tag) => ({
    params: { tag },
    props: { tag },
  }));
}

interface Props {
  tag: string;
}

const { tag } = Astro.props;

const allPosts = await getCollection("blog");
const taggedPosts = allPosts
  .filter((post) => (post.data.tags ?? []).includes(tag))
  .sort(
    (a, b) => b.data.pubDate - a.data.pubDate
  );
---

<BaseLayout
  title={`Posts tagged "${tag}" â€“ Nick`}
  description={`Blog posts tagged "${tag}".`}
>
  <section>
    <h1>#{tag}</h1>

    {taggedPosts.length === 0 && (
      <p>No posts found for this tag.</p>
    )}

    {taggedPosts.length > 0 && (
      <ul class="blog-list">
        {taggedPosts.map((post) => (
          <li class="blog-list__item">
            <a
              class="blog-list__link"
              href={`/blog/${post.slug}/`}
            >
              <h2 class="blog-list__title">
                {post.data.title}
              </h2>
              <p class="blog-list__meta">
                {post.data.pubDate.toLocaleDateString}
              </p>
            </a>
          </li>
        ))}
      </ul>
    )}

    <p style="margin-top: 2rem;">
      <a href="/tags">All tags</a>
    </p>
  </section>
</BaseLayout>

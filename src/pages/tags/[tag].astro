---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const tagSet = new Set<string>();

  for (const post of posts) {
    const tags = post.data.tags ?? [];
    for (const tag of tags) {
      tagSet.add(tag);
    }
  }

  return Array.from(tagSet).map((tag) => ({
    params: { tag },
    props: { tag },
  }));
}

interface Props {
  tag: string;
}

const { tag } = Astro.props;

const allPosts = await getCollection("blog");
const taggedPosts = allPosts
  .filter((post) => (post.data.tags ?? []).includes(tag))
  .sort(
    (a, b) => b.data.pubDate - a.data.pubDate
  );
---

<BaseLayout
  title={`Posts tagged "${tag}" â€“ Nick`}
  description={`Blog posts tagged "${tag}".`}
>
  <section>
    <h1>#{tag}</h1>

    {taggedPosts.length === 0 && (
      <p>No posts found for this tag.</p>
    )}

    {taggedPosts.length > 0 && (
      <ul class="blog-list">
        {taggedPosts.map((post) => {
          const tags = post.data.tags ?? [];
          return (
            <li class="blog-list__item">
              <h2 class="blog-list__title">
                <a href={`/blog/${post.slug}/`}>{post.data.title}</a>
              </h2>

              <p class="blog-list__meta">
                <span class="blog-list__date">
                  {post.data.pubDate}
                </span>

                {tags.length > 0 && (
                  <span class="blog-list__tag-row">
                    {tags.map((tag) => (
                      <a
                        href={`/tags/${encodeURIComponent(tag)}/`}
                        class="tag-pill"
                      >
                        {tag}
                      </a>
                    ))}
                  </span>
                )}
              </p>
            </li>
          );
        })}
      </ul>
    )}

    <p style="margin-top: 2rem;">
      <a href="/tags">All tags</a>
    </p>
  </section>
</BaseLayout>
